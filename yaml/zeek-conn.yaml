name: zeek_conn
description: "Zeek Conn logs"
title: "Zeek Conn"
autoloader:
  inputs:
  - /Volumes/logs/logs/logs/dsl_grp/zeek/conn/ # CHANGE ME! /Volumes/logs/<SOURCE>/<SOURCE_TYPE>/
  format: json

bronze:
  name: zeek_conn_bronze
  loadAsSingleVariant: true
  preTransform:
    -
      - "data"
      # - "_metadata.file_path"
      - CAST(data:ts AS TIMESTAMP) as time
      - CAST(time AS DATE) as date
      # - CAST(NULL AS STRING) as host  # Optional: no hostname in conn logs
      - CAST('zeek' AS STRING) AS source
      - CAST('conn' AS STRING) AS sourcetype
      - CURRENT_TIMESTAMP() as processed_time

silver:
  transform:
    - name: zeek_conn_silver
      fields:
        - name: id_origin_host
          expr: try_cast(data:['id.orig_h'] as STRING)
        - name: id_origin_port
          expr: try_cast(data:['id.orig_p'] as INT)
        - name: id_response_host
          expr: try_cast(data:['id.resp_h'] as STRING)
        - name: id_response_port
          expr: try_cast(data:['id.resp_p'] as INT)
        - name: conn_state
          expr: try_cast(data:['conn_state'] as STRING)
      utils:
        unreferencedColumns:
          preserve: true
          omitColumns:
            - data:['id.resp_h']
            - data:['id.orig_h']
            - data:ts
            - data:['id.resp_p']
            - data:['id.orig_p']
gold:
  # Note: clusterBy is supported in SSS (Spark Structured Streaming) mode but not in SDP mode (sinks don't support it atm)
  # For SDP mode, run ALTER TABLE after pipeline creation:
  #   ALTER TABLE <catalog>.<database>.<table_name> CLUSTER BY (time, <other_fields>)
  - name: network_activity
    input: zeek_conn_silver
    # catalog: my_catalog  # Optional: Unity Catalog catalog name
    # database: my_database  # Optional: database name (required if catalog is specified)
    # clusterBy: ["time", "src_endpoint.ip"]  # Only works in SSS mode (src/sss_gold.py)
    fields:
      - name: activity_id
        expr: |
          cast(
            CASE
              WHEN conn_state IN ('SF', 'RSTO', 'RSTR', 'RSTRH', 'SH', 'SHR') THEN 2
              WHEN conn_state = 'S0' THEN 4
              WHEN conn_state = 'REJ' THEN 5
              ELSE 6
            END
          as int)
      - name: activity_name
        expr: |
          CASE
              WHEN conn_state IN ('SF', 'RSTO', 'RSTR', 'RSTRH', 'SH', 'SHR') THEN 'Close'
              WHEN conn_state = 'S0' THEN 'Fail'
              WHEN conn_state = 'REJ' THEN 'Refuse'
              ELSE 'Traffic'
          END
      - name: activity
        expr: |
          CASE
              WHEN conn_state IN ('SF', 'RSTO', 'RSTR', 'RSTRH', 'SH', 'SHR') THEN 'Close'
              WHEN conn_state = 'S0' THEN 'Fail'
              WHEN conn_state = 'REJ' THEN 'Refuse'
              ELSE 'Traffic'
          END
      - name: action
        expr: |
          CASE
            WHEN conn_state = 'REJ' THEN 'Denied'
            WHEN conn_state IN ('S0', 'S1', 'RSTOS0', 'OTH') THEN 'Failed'
            ELSE 'Allowed'
          END
      - name: action_id
        expr: |
          CAST(CASE
            WHEN conn_state = 'REJ' THEN 2
            WHEN conn_state IN ('S0', 'S1', 'RSTOS0', 'OTH') THEN 0
            ELSE 1
          END AS INT)
      - name: category_uid
        expr: CAST('4' AS INT)
      - name: category_name
        literal: Network Activity
      - name: class_uid
        expr: CAST('4001' AS INT)
      - name: class_name
        literal: Network Activity
      - name: severity_id
        expr: CAST('1' AS INT)
      - name: severity
        literal: Informational
      - name: type_uid
        expr: CAST(class_uid * 100 + activity_id AS BIGINT)
      - name: type_name
        expr: "concat('Network Activity: ', activity_name)"
      - name: time
        from: time
      - name: start_time
        from: time
      - name: end_time
        expr: |
          CASE 
            WHEN data:duration::DOUBLE IS NOT NULL 
            THEN from_unixtime(unix_timestamp(time) + data:duration::DOUBLE)
            ELSE NULL
          END
      - name: timezone_offset
        expr: CAST(NULL AS INT)
      - name: metadata.version
        literal: "1.7.0"
      - name: metadata.product.name
        literal: Zeek Conn
      - name: metadata.product.vendor_name
        literal: Zeek
      - name: metadata.uid
        expr: data:uid::STRING
      - name: metadata.log_provider
        literal: zeek
      - name: metadata.log_name
        literal: conn
      - name: metadata.log_format
        literal: JSON
      - name: metadata.log_version
        literal: "zeek@conn:version@1.0"
      - name: metadata.processed_time
        expr: current_timestamp()
      - name: metadata.logged_time
        from: time
      - name: src_endpoint.ip
        from: id_origin_host
      - name: dst_endpoint.ip
        from: id_response_host
      - name: src_endpoint.port
        from: id_origin_port
      - name: dst_endpoint.port
        from: id_response_port
      - name: connection_info.uid
        expr: data:uid::STRING
      - name: connection_info.protocol_name
        expr: lower(data:proto::STRING)
      - name: connection_info.flag_history
        expr: data:history::STRING
      - name: connection_info.protocol_num
        expr: |
          CAST((
            CASE WHEN LOWER(data:proto::STRING) = 'icmp' THEN 1
            WHEN LOWER(data:proto::STRING) = 'tcp' THEN 6
            WHEN LOWER(data:proto::STRING) = 'udp' THEN 17
            ELSE NULL END)
          AS INT)
      - name: connection_info.direction_id
        expr: |
          CASE
            WHEN
              (
                id_origin_host RLIKE '^10\\.'
                OR id_origin_host RLIKE '^192\\.168\\.'
                OR id_origin_host RLIKE '^172\\.(1[6-9]|2[0-9]|3[0-1])\\.'
              )
              AND
              (
                id_response_host RLIKE '^10\\.'
                OR id_response_host RLIKE '^192\\.168\\.'
                OR id_response_host RLIKE '^172\\.(1[6-9]|2[0-9]|3[0-1])\\.'
              )
            THEN 3

            WHEN
              (
                id_origin_host RLIKE '^10\\.'
                OR id_origin_host RLIKE '^192\\.168\\.'
                OR id_origin_host RLIKE '^172\\.(1[6-9]|2[0-9]|3[0-1])\\.'
              )
              AND NOT
              (
                id_response_host RLIKE '^10\\.'
                OR id_response_host RLIKE '^192\\.168\\.'
                OR id_response_host RLIKE '^172\\.(1[6-9]|2[0-9]|3[0-1])\\.'
              )
            THEN 2

            WHEN
              NOT
              (
                id_origin_host RLIKE '^10\\.'
                OR id_origin_host RLIKE '^192\\.168\\.'
                OR id_origin_host RLIKE '^172\\.(1[6-9]|2[0-9]|3[0-1])\\.'
              )
              AND
              (
                id_response_host RLIKE '^10\\.'
                OR id_response_host RLIKE '^192\\.168\\.'
                OR id_response_host RLIKE '^172\\.(1[6-9]|2[0-9]|3[0-1])\\.'
              )
            THEN 1

            ELSE 0
          END
      - name: connection_info.direction
        expr: |
          CASE
            WHEN
              (
                id_origin_host RLIKE '^10\\.'
                OR id_origin_host RLIKE '^192\\.168\\.'
                OR id_origin_host RLIKE '^172\\.(1[6-9]|2[0-9]|3[0-1])\\.'
              )
              AND
              (
                id_response_host RLIKE '^10\\.'
                OR id_response_host RLIKE '^192\\.168\\.'
                OR id_response_host RLIKE '^172\\.(1[6-9]|2[0-9]|3[0-1])\\.'
              )
            THEN 'Lateral'

            WHEN
              (
                id_origin_host RLIKE '^10\\.'
                OR id_origin_host RLIKE '^192\\.168\\.'
                OR id_origin_host RLIKE '^172\\.(1[6-9]|2[0-9]|3[0-1])\\.'
              )
              AND NOT
              (
                id_response_host RLIKE '^10\\.'
                OR id_response_host RLIKE '^192\\.168\\.'
                OR id_response_host RLIKE '^172\\.(1[6-9]|2[0-9]|3[0-1])\\.'
              )
            THEN 'Outbound'

            WHEN
              NOT
              (
                id_origin_host RLIKE '^10\\.'
                OR id_origin_host RLIKE '^192\\.168\\.'
                OR id_origin_host RLIKE '^172\\.(1[6-9]|2[0-9]|3[0-1])\\.'
              )
              AND
              (
                id_response_host RLIKE '^10\\.'
                OR id_response_host RLIKE '^192\\.168\\.'
                OR id_response_host RLIKE '^172\\.(1[6-9]|2[0-9]|3[0-1])\\.'
              )
            THEN 'Inbound'

            ELSE 'Unknown'
          END

      - name: status
        expr: |
          CASE
            WHEN activity_id IN ('4', '5') THEN 'Failure'
            WHEN activity_id = '0' THEN 'Unknown'
            WHEN activity_id = '99' THEN 'Other'
            ELSE 'Success'
          END
      - name: status_id
        expr: |
          CASE
            WHEN activity_id IN ('4', '5') THEN 2
            WHEN activity_id = '0' THEN 0
            WHEN activity_id = '99' THEN 99
            ELSE 1
          END
      - name: status_code
        from: conn_state
      - name: status_detail
        expr: |
          CASE
            WHEN conn_state = 'S0' THEN 'Connection attempt seen, no reply'
            WHEN conn_state = 'S1' THEN 'Connection established, not terminated'
            WHEN conn_state = 'SF' THEN 'Normal establishment and termination'
            WHEN conn_state = 'REJ' THEN 'Connection attempt rejected'
            WHEN conn_state = 'S2' THEN 'Connection established and close attempt by originator seen'
            WHEN conn_state = 'S3' THEN 'Connection established and close attempt by responder seen'
            WHEN conn_state = 'RSTO' THEN 'Connection established, originator aborted'
            WHEN conn_state = 'RSTR' THEN 'Responder sent a RST'
            WHEN conn_state = 'RSTOS0' THEN 'Originator sent a SYN followed by a RST'
            WHEN conn_state = 'RSTRH' THEN 'Responder sent a SYN ACK followed by a RST'
            WHEN conn_state = 'SH' THEN 'Originator sent a SYN followed by a FIN'
            WHEN conn_state = 'SHR' THEN 'Responder sent a SYN ACK followed by a FIN'
            WHEN conn_state = 'OTH' THEN 'No SYN seen, just midstream traffic'
            ELSE conn_state
          END
      - name: disposition
        expr: |
          CASE
            WHEN conn_state = 'REJ' THEN 'Blocked'
            WHEN conn_state IN ('S0', 'RSTOS0') THEN 'Failed'
            ELSE 'Allowed'
          END
      - name: disposition_id
        expr: |
          CAST(CASE
            WHEN conn_state = 'REJ' THEN 2
            WHEN conn_state IN ('S0', 'RSTOS0') THEN 4
            ELSE 1
          END AS INT)
      - name: traffic.bytes_in
        expr: data:resp_bytes::BIGINT
      - name: traffic.bytes_out
        expr: data:orig_bytes::BIGINT
      - name: traffic.bytes
        expr: data:resp_bytes::BIGINT + data:orig_bytes::BIGINT
      - name: traffic.packets_in
        expr: data:resp_pkts::BIGINT
      - name: traffic.packets_out
        expr: data:orig_pkts::BIGINT
      - name: traffic.packets
        expr: data:orig_pkts::BIGINT + data:resp_pkts::BIGINT
      - name: src_endpoint.mac
        expr: data:orig_l2_addr::STRING
      - name: dst_endpoint.mac
        expr: data:resp_l2_addr::STRING
      - name: message
        expr: |
          concat(
            'Network connection ',
            activity_name,
            ' from ',
            COALESCE(id_origin_host, 'unknown'),
            ':',
            COALESCE(CAST(id_origin_port AS STRING), '?'),
            ' to ',
            COALESCE(id_response_host, 'unknown'),
            ':',
            COALESCE(CAST(id_response_port AS STRING), '?'),
            ' (',
            COALESCE(UPPER(data:proto::STRING), 'unknown'),
            ') - ',
            COALESCE(status_detail, conn_state)
          )
      - name: raw_data
        from: data
      - name: unmapped
        expr: |
          CAST(
            to_json(
              named_struct(
                'uid', data:uid::STRING,
                'conn_state', conn_state,
                'local_orig', data:local_orig::BOOLEAN,
                'local_resp', data:local_resp::BOOLEAN,
                'missed_bytes', data:missed_bytes::BIGINT,
                'history', data:history::STRING,
                'orig_ip_bytes', data:orig_ip_bytes::BIGINT,
                'resp_ip_bytes', data:resp_ip_bytes::BIGINT,
                'tunnel_parents', data:tunnel_parents::STRING,
                'duration', data:duration::DOUBLE,
                'service', data:service::STRING,
                'vlan', data:vlan::INT,
                'inner_vlan', data:inner_vlan::INT
              )
            )
          AS VARIANT)